# ETP-R1 é¡¹ç›®ä¿®æ”¹è®°å½•

## 2025-12-26: 12ç›® â†’ 4ç›®ç›¸æœºé…ç½®è¿ç§»

### æ¦‚è¿°
å°†åŸæœ‰12ç›®ç›¸æœºï¼ˆ12Ã—3=36è§†è§’ï¼‰é…ç½®ä¿®æ”¹ä¸º4ç›®ç›¸æœºï¼ˆ4Ã—3=12è§†è§’ï¼‰é…ç½®ï¼Œä»¥é€‚é…å®é™…ç¡¬ä»¶ã€‚

---

### 1. é¢„è®¡ç®—ç‰¹å¾æå– (`precompute_img_features/`)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `save_img.py` | `VIEWPOINT_SIZE`: 36â†’12, `VFOV`: 60â†’90, headingå¢é‡ 1.0â†’3.0, ä»°è§’åˆ‡æ¢ %12â†’%4, `sys.path` æ›´æ–° |
| `extract_rgb_features.py` | `VIEWPOINT_SIZE`: 36â†’12, `batch_size`: 36â†’12, img_dbè·¯å¾„ vfov60â†’vfov90 |
| `extract_depth_features.py` | `VIEWPOINT_SIZE`: 36â†’12, `batch_size`: 36â†’12, img_dbè·¯å¾„ vfov60â†’vfov90 |
| `run.bash` | `PYTHONPATH` æ›´æ–°ä¸º `/home/wdm/Matterport3DSimulator_copy/build` |

---

### 2. Waypoint Predictor (`waypoint-predictor/`)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `run_waypoint.bash` | `ANGLES`: 40, `NUM_IMGS`: 4, `BATCH_SIZE`: 32, `CUDA_VISIBLE_DEVICES=0` |
| `image_encoders.py` | ddppoè·¯å¾„æ›´æ–°ä¸º `/home/wdm/ICRA2026_etpnav/data/ddppo-models/` |
| `gen_training_data/get_images_inputs.py` | `NUMBER`: 4, è·¯å¾„æ›´æ–° |
| `gen_training_data/get_nav_dict.py` | `NUMBER`: 40, è·¯å¾„æ›´æ–° |
| `gen_training_data/test_twm0.2_obstacle_first.py` | `ANGLES`: 40 |

**æ•°æ®ç”Ÿæˆå®Œæˆ**: `training_data/rgbd_fov90_4cam/`, `40_*_mp3d_waypoint_*.json`

---

### 3. é¢„è®­ç»ƒä»£ç  (`pretrain_src/pretrain_src_4/`)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `data/common.py` | `get_view_rel_angles()`: 12 views, 90Â°å¢é‡, æ¯4è§†è§’åˆ‡æ¢ä»°è§’ |
| `data/dataset.py` | `all_point_rel_angles`: range(12), è§†è§’ç´¢å¼• 12â†’4, heading %12â†’%4, 30Â°â†’90Â°, nav_types 36â†’12 |
| `run_pt_4/run_mix_server.bash` | è„šæœ¬è·¯å¾„æ›´æ–°ä¸º `pretrain_src_4` å’Œ `run_pt_4`, è¾“å‡ºç›®å½• `r2r_rxr_ce_4cam` |

---

### 4. SFT è®­ç»ƒä»£ç  (`vlnce_baselines/`)

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `waypoint_pred/TRM_net.py` | `num_angles`: 120â†’40, `num_imgs`: 12â†’4 |
| `waypoint_pred/utils.py` | `get_attention_mask` é»˜è®¤å‚æ•°: 12â†’4 |
| `utils.py` | æ–°å¢ `get_camera_orientations4()` å‡½æ•° (90Â°é—´éš”) |
| `common/utils.py` | æ–°å¢ `get_camera_orientations4()` å‡½æ•° (90Â°é—´éš”) |
| `common/base_il_trainer.py` | å¯¼å…¥å¹¶ä½¿ç”¨ `get_camera_orientations4` |
| `models/R1Policy.py` | `pano_img_idxes`: 0-11â†’0-3, `NUM_ANGLES`: 120â†’40, `NUM_IMGS`: 12â†’4 |
| `ss_trainer_ETP_R1.py` | å¯¼å…¥ `get_camera_orientations4`, `cand_idxes`: 12â†’4, `nav_types`: 12â†’4 |
| `GRPO_trainer_ETP_R1.py` | åŒä¸Š SFT trainer çš„ä¿®æ”¹ |

---

### å…³é”®å‚æ•°æ˜ å°„

| å‚æ•° | 12ç›® (åŸ) | 4ç›® (æ–°) |
|------|-----------|----------|
| æ€»è§†è§’æ•° | 36 | 12 |
| æ¯å±‚ç›¸æœºæ•° | 12 | 4 |
| æ°´å¹³FOV | 30Â° | 90Â° |
| VFOV | 60Â° | 90Â° |
| Waypoint ANGLES | 120 | 40 |
| NUM_IMGS (SFT) | 12 | 4 |

---

### å¾…å®Œæˆ
- [ ] ç”Ÿæˆ4ç›®é¢„è®­ç»ƒç‰¹å¾æ–‡ä»¶ (CLIP, Depth)
- [ ] é…ç½® `mix_pretrain_server.json` ä¸­çš„ç‰¹å¾æ–‡ä»¶è·¯å¾„
- [ ] è®­ç»ƒ Waypoint Predictor
- [ ] è¿è¡Œé¢„è®­ç»ƒ
- [ ] è¿è¡Œ SFT è®­ç»ƒ
- [ ] è¿è¡Œ GRPO è®­ç»ƒ

---

## 2025-12-27: 12ç›® vs 4ç›® ä»£ç å¯¹æ¯”åˆ†æ

### æ£€æŸ¥ç»“è®º

ç»è¿‡è¯¦ç»†å¯¹æ¯” `vlnce_baselines/` (4ç›®) å’Œ `vlnce_baselines_orin/` (12ç›®) ä»£ç ï¼Œ**ä¸»è¦ä»£ç ä¿®æ”¹å·²æ­£ç¡®å®Œæˆ**ã€‚

#### âœ… å·²æ­£ç¡®ä¿®æ”¹çš„éƒ¨åˆ†

| æ–‡ä»¶ | 12ç›® | 4ç›® | çŠ¶æ€ |
|------|------|-----|------|
| `utils.py` | `get_camera_orientations12()` | `get_camera_orientations4()` | âœ… |
| `ss_trainer_ETP_R1.py` L40 | å¯¼å…¥ `get_camera_orientations12` | å¯¼å…¥ `get_camera_orientations4` | âœ… |
| `ss_trainer_ETP_R1.py` L110 | è°ƒç”¨ `get_camera_orientations12()` | è°ƒç”¨ `get_camera_orientations4()` | âœ… |
| `ss_trainer_ETP_R1.py` L386 | `cand_idxes = np.zeros(12)` | `cand_idxes = np.zeros(4)` | âœ… |
| `ss_trainer_ETP_R1.py` L397 | `nav_types += [0] * (12-np.sum())` | `nav_types += [0] * (4-np.sum())` | âœ… |
| `models/R1Policy.py` L144 | `pano_img_idxes = np.arange(0, 12)` | `pano_img_idxes = np.arange(0, 4)` | âœ… |
| `models/R1Policy.py` L145 | `/12` | `/4` | âœ… |
| `models/R1Policy.py` L179 | `NUM_ANGLES = 120` | `NUM_ANGLES = 40` | âœ… |
| `models/R1Policy.py` L180 | `NUM_IMGS = 12` | `NUM_IMGS = 4` | âœ… |
| `models/R1Policy.py` L258 | `reshape(..., 12, 10, 12)` | `reshape(..., 4, 10, 12)` | âœ… |
| `models/R1Policy.py` L267 | `img_idxes==12` | `img_idxes==4` | âœ… |
| `models/R1Policy.py` L310 | `/120` | `/40` | âœ… |
| `models/R1Policy.py` L316 | `12 - ...` | `4 - ...` | âœ… |
| `models/R1Policy.py` L317 | `img_idxes==12` | `img_idxes==4` | âœ… |
| `waypoint_pred/TRM_net.py` | `num_angles=120, num_imgs=12` | `num_angles=40, num_imgs=4` | âœ… |

---

### âš ï¸ éœ€æ‰‹åŠ¨ç¡®è®¤çš„é…ç½®é¡¹

è¿è¡Œ4ç›®SFTè®­ç»ƒæ—¶ï¼Œè¯·ç¡®ä¿ä»¥ä¸‹é…ç½®æ­£ç¡®ï¼š

#### 1. é¢„è®­ç»ƒæƒé‡è·¯å¾„ (`run_r2r/iter_train.yaml`)

å½“å‰é…ç½®ï¼š
```yaml
pretrained_path: pretrained/ETP/mlm.sap_r2r/ckpts/model_step_82500.pt
```

**è¯·ä¿®æ”¹ä¸º4ç›®é¢„è®­ç»ƒæƒé‡è·¯å¾„**ï¼Œä¾‹å¦‚ï¼š
```yaml
pretrained_path: pretrained/r2r_rxr_ce_4cam/mlm.sap_habitat_depth/ckpts/model_step_XXXXX.pt
```

#### 2. Waypoint Predictor æƒé‡ (`ss_trainer_ETP_R1.py` L214)

å½“å‰ç¡¬ç¼–ç è·¯å¾„ï¼š
```python
cwp_fn = 'data/wp_pred/check_cwp_bestdist_hfov90'
```

**è¯·ç¡®ä¿æ­¤è·¯å¾„æŒ‡å‘çš„æ˜¯4ç›®è®­ç»ƒçš„waypoint predictoræƒé‡**ï¼Œæˆ–ä¿®æ”¹ä¸ºæ–°è·¯å¾„ã€‚

#### 3. é…ç½®æ–‡ä»¶ NUM_ANGLES (`run_r2r/iter_train.yaml` L108)

å½“å‰é…ç½®ï¼š
```yaml
MODEL:
  NUM_ANGLES: 12
```

ç»æ£€æŸ¥ï¼Œ**æ­¤é…ç½®é¡¹æœªè¢«ä»£ç ä½¿ç”¨**ï¼Œ`NUM_ANGLES` åœ¨ `R1Policy.py` ä¸­æ˜¯ç¡¬ç¼–ç çš„ (`NUM_ANGLES = 40`)ï¼Œæ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚

---

### âœ… é¢„è®­ç»ƒä»£ç åˆ†æ (`pretrain_src/pretrain_src_4/mydata/`)

#### common.py - `get_view_rel_angles()`
- **ä¿®æ”¹æ­£ç¡®**: 12 views (4Ã—3), 90Â° heading increment
- `NUM_VIEWS = 12`, `NUM_CAMERAS = 4`
- Heading: `math.radians(90)` å¢é‡

#### dataset.py - å…³é”®ä¿®æ”¹ç‚¹
| ä½ç½® | 12ç›® | 4ç›® | çŠ¶æ€ |
|------|------|-----|------|
| L57 | `range(36)` | `range(12)` | âœ… |
| L221 | `viewidx % 12` | `viewidx % 4` | âœ… |
| L222 | `viewidx // 12` | `viewidx // 4` | âœ… |
| L243 | `all_point_rel_angles[12]` | `all_point_rel_angles[4]` | âœ… |
| L247 | `range(36)` | `range(12)` | âœ… |
| L248 | `all_point_rel_angles[12]` | `all_point_rel_angles[4]` | âœ… |
| L276 | `36 - len()` | `12 - len()` | âœ… |
| L493 | `all_point_rel_angles[12]` | `all_point_rel_angles[4]` | âœ… |
| L497-499 | `range(36)` | `range(12)` | âœ… |
| L510 | `36 - len()` | `12 - len()` | âœ… |

**ç»“è®º**: é¢„è®­ç»ƒä»£ç ä¿®æ”¹æ­£ç¡®ï¼Œä¸SFTä»£ç çš„è§†å›¾é¡ºåºå’Œè§’åº¦è®¡ç®—ä¿æŒä¸€è‡´ã€‚

---

### ğŸ“ è§†å›¾é¡ºåºåˆ†æ

#### pano_angle_fts è®¡ç®—

ä¸¤ä¸ªç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„å…¬å¼ï¼š
```python
pano_angle_rad_c = (1 - self.pano_img_idxes / N) * 2 * math.pi
```

12ç›®: `[360Â°, 330Â°, 300Â°, ..., 30Â°]` (é€†æ—¶é’ˆ)
4ç›®: `[360Â°, 270Â°, 180Â°, 90Â°]` = `[0Â°, 270Â°, 180Â°, 90Â°]` (é€†æ—¶é’ˆ)

è¿™ä¸ªå…¬å¼ä½¿è§’åº¦ç‰¹å¾ä¸å®é™…è§†å›¾æ–¹å‘**åŒ¹é…**ï¼ˆç»è¿‡ä¸¤æ¬¡é€†åºå¤„ç†åï¼‰ã€‚

#### ç»“è®º

å¦‚æœ12ç›®ç‰ˆæœ¬åœ¨è¿™ä¸ªå…¬å¼ä¸‹èƒ½æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆ4ç›®ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„å…¬å¼é€»è¾‘ä¹Ÿåº”è¯¥èƒ½æ­£å¸¸å·¥ä½œï¼Œ**å‰ææ˜¯é¢„è®­ç»ƒæƒé‡å’Œwaypoint predictoræƒé‡éƒ½æ˜¯4ç›®ç‰ˆæœ¬çš„**ã€‚

---

### ğŸ”´ æœ€ç»ˆç»“è®º

**ä»£ç å±‚é¢æ²¡æœ‰é—®é¢˜**ã€‚æ‰€æœ‰å…³é”®å‚æ•°ï¼ˆNUM_VIEWS, NUM_IMGS, NUM_ANGLES, è§†å›¾ç´¢å¼•é€»è¾‘ï¼‰éƒ½å·²æ­£ç¡®ä¿®æ”¹ä¸º4ç›®é…ç½®ã€‚

SFTè®­ç»ƒ"åƒé‡æ–°å¼€å§‹"çš„æœ€å¯èƒ½åŸå› ï¼š

1. **ä½¿ç”¨äº†12ç›®çš„é¢„è®­ç»ƒæƒé‡**ï¼šè™½ç„¶æ¨¡å‹ç»“æ„å…¼å®¹ï¼ˆVLN-BERTæ ¸å¿ƒå±‚å®Œå…¨ä¸€æ ·ï¼‰ï¼Œä½†é¢„è®­ç»ƒå­¦ä¹ çš„è§†è§‰-è¯­è¨€å¯¹é½æ˜¯åŸºäº12è§†å›¾çš„ç‰¹å¾åˆ†å¸ƒ
2. **ä½¿ç”¨äº†12ç›®çš„waypoint predictor**ï¼šè¾“å…¥/è¾“å‡ºç»´åº¦ä¸åŒ¹é…ï¼ˆ`num_imgs=12` vs `num_imgs=4`ï¼‰ä¼šå¯¼è‡´æ¨ç†å®Œå…¨å¤±è´¥

### âœ… éªŒè¯æ–¹æ³•

è¿è¡ŒSFTè®­ç»ƒæ—¶ï¼Œè§‚å¯Ÿæ—¥å¿—ä¸­çš„æƒé‡åŠ è½½æŠ¥å‘Šï¼š
```
Weight loading mismatch report
```

å¦‚æœæ˜¾ç¤º "All network layers present in the model were found in the weight file" ä¸”æ²¡æœ‰å¤§é‡ unexpected keysï¼Œè¯´æ˜é¢„è®­ç»ƒæƒé‡åŠ è½½æ­£ç¡®ã€‚

---

## ğŸ”¬ æ·±å…¥åˆ†æï¼šè§†å›¾é¡ºåºè¿½è¸ª

### é—®é¢˜ï¼š`pano_angle_fts` ä¸ `pano_rgb` æ˜¯å¦å¯¹é½ï¼Ÿ

#### æ­¥éª¤1ï¼šç›¸æœºé…ç½®é¡ºåº

**12ç›®ç‰ˆæœ¬** - `get_camera_orientations12()` è¿”å›:
```
{'30': [0,30Â°,0], '60': [0,60Â°,0], ..., '330': [0,330Â°,0]}
```
åŠ ä¸Šä¸»ç›¸æœº 0Â°ï¼Œå…±12ä¸ª: `[0Â°, 30Â°, 60Â°, 90Â°, 120Â°, 150Â°, 180Â°, 210Â°, 240Â°, 270Â°, 300Â°, 330Â°]`

**4ç›®ç‰ˆæœ¬** - `get_camera_orientations4()` è¿”å›:
```
{'90': [0,90Â°,0], '180': [0,180Â°,0], '270': [0,270Â°,0]}
```
åŠ ä¸Šä¸»ç›¸æœº 0Â°ï¼Œå…±4ä¸ª: `[0Â°, 90Â°, 180Â°, 270Â°]`

#### æ­¥éª¤2ï¼šobservations å­—å…¸è¿­ä»£é¡ºåº

æ ¹æ® `ss_trainer_ETP_R1.py` ä¸­çš„é…ç½®é¡ºåºï¼ŒSENSORS åˆ—è¡¨æ˜¯ï¼š
```
[RGB_SENSOR, DEPTH_SENSOR] + [RGB_90, DEPTH_90, RGB_180, DEPTH_180, RGB_270, DEPTH_270]
```

**å‡è®¾** `observations.items()` æŒ‰å­—å…¸é”®æ’åºåè¿­ä»£ï¼Œdepth é”®çš„é¡ºåºæ˜¯ï¼š
- depth (0Â°) â†’ depth_180 â†’ depth_270 â†’ depth_90 (æŒ‰å­—æ¯åº)

æˆ–è€…å¯èƒ½æŒ‰SENSORSæ·»åŠ é¡ºåºï¼š
- depth (0Â°) â†’ depth_90 â†’ depth_180 â†’ depth_270

**âš ï¸ è¿™æ˜¯ä¸€ä¸ªå…³é”®çš„ä¸ç¡®å®šç‚¹ï¼** éœ€è¦åœ¨è¿è¡Œæ—¶æ‰“å°ç¡®è®¤ã€‚

#### æ­¥éª¤3ï¼šç¬¬ä¸€æ¬¡é‡æ’åºï¼ˆè¿›å…¥ waypoint predictor ä¹‹å‰ï¼‰

ä»£ç é€»è¾‘ï¼š
```python
ra_count = (NUM_IMGS - a_count) % NUM_IMGS
```

**å‡è®¾ observations æŒ‰ [0Â°, 90Â°, 180Â°, 270Â°] é¡ºåºè¿­ä»£ï¼š**

| a_count | ç›¸æœºè§’åº¦ | ra_count = (4-a_count)%4 | depth_batch[ra_count] |
|---------|---------|--------------------------|----------------------|
| 0 | 0Â° | 0 | depth_batch[0] = 0Â° |
| 1 | 90Â° | 3 | depth_batch[3] = 90Â° |
| 2 | 180Â° | 2 | depth_batch[2] = 180Â° |
| 3 | 270Â° | 1 | depth_batch[1] = 270Â° |

**depth_batch é¡ºåº**: `[0Â°, 270Â°, 180Â°, 90Â°]` (è¿™æ˜¯é¡ºæ—¶é’ˆé¡ºåºï¼)

#### æ­¥éª¤4ï¼šç¬¬äºŒæ¬¡é‡æ’åºï¼ˆwaypoint prediction ä¹‹åï¼‰

ä»£ç é€»è¾‘ï¼š
```python
rgb_feats = torch.cat((
    rgb_embed_reshape[:,0:1,:],           # ä¿æŒç´¢å¼•0
    torch.flip(rgb_embed_reshape[:,1:,:], [1]),  # ç¿»è½¬ç´¢å¼•1,2,3
), dim=1)
```

**è¾“å…¥**: `[0Â°, 270Â°, 180Â°, 90Â°]`
**ç´¢å¼•0ä¿æŒ**: `0Â°`
**ç´¢å¼•1,2,3ç¿»è½¬**: `flip([270Â°, 180Â°, 90Â°])` = `[90Â°, 180Â°, 270Â°]`
**è¾“å‡º pano_rgb**: `[0Â°, 90Â°, 180Â°, 270Â°]` âœ… (é€†æ—¶é’ˆ)

#### æ­¥éª¤5ï¼špano_angle_fts è®¡ç®—

å…¬å¼ï¼š
```python
pano_angle_rad_c = (1 - pano_img_idxes/4) * 2 * math.pi
```

| pano_img_idxes | è®¡ç®— | è§’åº¦ |
|----------------|------|------|
| 0 | (1-0/4)*2Ï€ | 360Â° = 0Â° |
| 1 | (1-1/4)*2Ï€ | 270Â° |
| 2 | (1-2/4)*2Ï€ | 180Â° |
| 3 | (1-3/4)*2Ï€ | 90Â° |

**pano_angle_fts é¡ºåº**: `[0Â°, 270Â°, 180Â°, 90Â°]` (è¿™æ˜¯é¡ºæ—¶é’ˆé¡ºåºï¼)

#### âŒ 4ç›®ç‰ˆæœ¬çš„å¯¹é½é—®é¢˜ï¼

| ç´¢å¼• | pano_rgb (è§†è§‰ç‰¹å¾) | pano_angle_fts (è§’åº¦ç‰¹å¾) | åŒ¹é…ï¼Ÿ |
|------|---------------------|--------------------------|--------|
| 0 | 0Â° | 0Â° | âœ… |
| 1 | 90Â° | 270Â° | âŒ **é”™ä½ï¼** |
| 2 | 180Â° | 180Â° | âœ… |
| 3 | 270Â° | 90Â° | âŒ **é”™ä½ï¼** |

### ğŸ” 12ç›®ç‰ˆæœ¬æ˜¯å¦æœ‰åŒæ ·çš„é—®é¢˜ï¼Ÿ

**12ç›®ç‰ˆæœ¬ pano_angle_fts è®¡ç®—ï¼š**
```python
pano_angle_rad_c = (1 - pano_img_idxes/12) * 2 * math.pi
```

| idx | è§’åº¦ |
|-----|------|
| 0 | 360Â° = 0Â° |
| 1 | 330Â° |
| 2 | 300Â° |
| ... | ... |
| 11 | 30Â° |

**12ç›® pano_angle_fts é¡ºåº**: `[0Â°, 330Â°, 300Â°, 270Â°, 240Â°, 210Â°, 180Â°, 150Â°, 120Â°, 90Â°, 60Â°, 30Â°]`

**12ç›® pano_rgb é¡ºåº**ï¼ˆç»è¿‡åŒæ ·çš„ä¸¤æ¬¡é‡æ’åºï¼‰: `[0Â°, 30Â°, 60Â°, 90Â°, 120Â°, 150Â°, 180Â°, 210Â°, 240Â°, 270Â°, 300Â°, 330Â°]`

| idx | pano_rgb | pano_angle_fts | åŒ¹é…ï¼Ÿ |
|-----|----------|----------------|--------|
| 0 | 0Â° | 0Â° | âœ… |
| 1 | 30Â° | 330Â° | âŒ |
| 2 | 60Â° | 300Â° | âŒ |
| ... | ... | ... | âŒ |
| 11 | 330Â° | 30Â° | âŒ |

**ç»“è®º: 12ç›®ç‰ˆæœ¬ä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼** è§’åº¦ç‰¹å¾å’Œè§†è§‰ç‰¹å¾æ˜¯åå‘çš„ï¼ˆé™¤äº†ç´¢å¼•0å’Œ6ï¼‰ã€‚

### ğŸ¤” ä¸ºä»€ä¹ˆ12ç›®èƒ½å·¥ä½œï¼Ÿ

å¯èƒ½çš„è§£é‡Šï¼š
1. **é¢„è®­ç»ƒæ—¶ä½¿ç”¨äº†ç›¸åŒçš„"é”™è¯¯"å…¬å¼** â€” æ¨¡å‹å­¦ä¼šäº†è¿™ç§å†…åœ¨ä¸€è‡´çš„ä¸å¯¹é½
2. **å¯¹ç§°æ€§** â€” ç”±äºä½¿ç”¨ `sin` å’Œ `cos` ä½œä¸ºç‰¹å¾ï¼Œ`sin(Î¸)` å’Œ `sin(-Î¸)` åªå·®ä¸€ä¸ªç¬¦å·ï¼Œæ¨¡å‹å¯èƒ½å­¦ä¼šäº†é€‚åº”

### âš¡ ä¿®å¤æ–¹æ¡ˆ

å°† `pano_angle_fts` çš„å…¬å¼æ”¹ä¸ºä¸ `pano_rgb` é¡ºåºä¸€è‡´ï¼š

**å½“å‰ï¼ˆé”™è¯¯ï¼‰:**
```python
pano_angle_rad_c = (1 - self.pano_img_idxes/N) * 2 * math.pi
```

**ä¿®å¤å:**
```python
pano_angle_rad_c = self.pano_img_idxes/N * 2 * math.pi
```

è¿™å°†ç”Ÿæˆ `[0Â°, 90Â°, 180Â°, 270Â°]`ï¼Œä¸ `pano_rgb` çš„ `[0Â°, 90Â°, 180Â°, 270Â°]` å®Œç¾åŒ¹é…ã€‚

### âš ï¸ é‡è¦è­¦å‘Š

å¦‚æœä¿®å¤4ç›®ç‰ˆæœ¬ï¼Œå¿…é¡»åŒæ—¶ï¼š
1. **ä¿®å¤4ç›®é¢„è®­ç»ƒä»£ç ä¸­çš„ç›¸åŒå…¬å¼**ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
2. **é‡æ–°è¿›è¡Œ4ç›®é¢„è®­ç»ƒ**
3. **æˆ–è€…** ä¿æŒä¸é¢„è®­ç»ƒä¸€è‡´çš„"é”™è¯¯"å…¬å¼ï¼Œè®©SFTå­¦ä¹ ç›¸åŒçš„æ˜ å°„

---

## ğŸš¨ å…³é”®å‘ç°ï¼šé¢„è®­ç»ƒä¸SFTä¹‹é—´çš„è§’åº¦é¡ºåºå¯¹æ¯”

### é¢„è®­ç»ƒä»£ç  (`pretrain_src_4/mydata/common.py`)

`get_view_rel_angles()` ç”Ÿæˆçš„è§’åº¦é¡ºåºï¼š

```python
for ix in range(NUM_VIEWS):
    if ix == 0:
        heading = 0
    elif ix % NUM_CAMERAS == 0:
        heading = 0
    else:
        heading += math.radians(90)  # 90Â° å¢é‡
```

**ç»“æœ**: æ¯å±‚4ä¸ªè§†å›¾æŒ‰ `[0Â°, 90Â°, 180Â°, 270Â°]` **é€†æ—¶é’ˆ**é¡ºåºæ’åˆ—

### SFTä»£ç  (`R1Policy.py`)

`pano_angle_fts` ç”Ÿæˆçš„è§’åº¦é¡ºåºï¼š

```python
pano_angle_rad_c = (1 - self.pano_img_idxes/4) * 2 * math.pi
```

**ç»“æœ**: `[0Â°, 270Â°, 180Â°, 90Â°]` **é¡ºæ—¶é’ˆ**é¡ºåº

### âŒ ç¡®è®¤ï¼šé¢„è®­ç»ƒå’ŒSFTä¹‹é—´å­˜åœ¨è§’åº¦æ–¹å‘ä¸ä¸€è‡´ï¼

| ç»„ä»¶ | è§’åº¦é¡ºåº | æ–¹å‘ |
|------|---------|------|
| é¢„è®­ç»ƒ `get_view_rel_angles()` | [0Â°, 90Â°, 180Â°, 270Â°] | é€†æ—¶é’ˆ âœ“ |
| SFT `pano_angle_fts` | [0Â°, 270Â°, 180Â°, 90Â°] | é¡ºæ—¶é’ˆ âœ— |

**è¿™å°±æ˜¯4ç›®SFTè¡¨ç°å·®çš„æ ¹æœ¬åŸå› ï¼**

é¢„è®­ç»ƒæ—¶æ¨¡å‹å­¦ä¼šäº†å°† "90Â° ä½ç½®çš„è§†è§‰ç‰¹å¾" ä¸ "90Â° çš„è§’åº¦ç‰¹å¾" å…³è”èµ·æ¥ã€‚
ä½†SFTæ—¶ï¼Œ"90Â° ä½ç½®çš„è§†è§‰ç‰¹å¾" è¢«é…å¯¹äº† "270Â° çš„è§’åº¦ç‰¹å¾"ï¼Œå¯¼è‡´æ¨¡å‹å›°æƒ‘ã€‚

### âœ… ä¿®å¤æ–¹æ¡ˆ (å·²å®Œæˆ 2025-12-27)

**å·²ä¿®æ”¹ `vlnce_baselines/models/R1Policy.py` ç¬¬145è¡Œï¼š**

```diff
- pano_angle_rad_c = (1-self.pano_img_idxes/4) * 2 * math.pi
+ # Fixed: ä½¿ç”¨ idx/N * 2Ï€ ç”Ÿæˆé€†æ—¶é’ˆè§’åº¦ [0Â°, 90Â°, 180Â°, 270Â°]
+ # ä¸é¢„è®­ç»ƒ get_view_rel_angles() å’Œ pano_rgb é¡ºåºä¿æŒä¸€è‡´
+ pano_angle_rad_c = self.pano_img_idxes/4 * 2 * math.pi
```

è¿™æ · `pano_angle_fts` å°†å˜ä¸º `[0Â°, 90Â°, 180Â°, 270Â°]`ï¼Œä¸é¢„è®­ç»ƒå’Œ `pano_rgb` ä¿æŒä¸€è‡´ã€‚

### ğŸ” 12ç›®ä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿ

éœ€è¦æ£€æŸ¥12ç›®é¢„è®­ç»ƒä»£ç çš„ `get_view_rel_angles()` æ˜¯å¦ä¹Ÿä½¿ç”¨äº†é€†æ—¶é’ˆé¡ºåºã€‚å¦‚æœ12ç›®é¢„è®­ç»ƒå’ŒSFTéƒ½ä½¿ç”¨ç›¸åŒçš„ï¼ˆå¯èƒ½"é”™è¯¯"çš„ï¼‰é¡ºåºï¼Œæ¨¡å‹å°±èƒ½å­¦ä¼šè¿™ç§ä¸€è‡´çš„æ˜ å°„ã€‚

![12ç›®ä¸4ç›®è§’åº¦é¡ºåºå¯¹æ¯”](assets\debug.png)

---

## ğŸ”¬ æ›´æ·±å…¥åˆ†æï¼šå›¾åƒç”Ÿæˆä¸åŠ è½½æµç¨‹

### 1. é¢„è®­ç»ƒå›¾åƒç”Ÿæˆ (`save_img.py`)

```python
# save_img.py ç¬¬61-62è¡Œ
headings = [i * 2 * math.pi / HORIZONTAL_VIEWS for i in range(HORIZONTAL_VIEWS)]  # [0, Ï€/2, Ï€, 3Ï€/2]
elevations = [math.radians(-30), math.radians(0), math.radians(30)]

# ç¬¬82-84è¡Œ - ç”Ÿæˆé¡ºåºæ˜¯ï¼šelevationå¤–å¾ªç¯ï¼Œheadingå†…å¾ªç¯
for e in elevations:      # -30Â°, 0Â°, +30Â°
    for h in headings:    # 0Â°, 90Â°, 180Â°, 270Â°
```

**ç”Ÿæˆçš„12ä¸ªè§†å›¾ç´¢å¼•ï¼š**
| è§†å›¾ç´¢å¼• | ä»°è§’ | æ°´å¹³è§’ (heading) |
|---------|------|-----------------|
| 0 | -30Â° | 0Â° |
| 1 | -30Â° | 90Â° |
| 2 | -30Â° | 180Â° |
| 3 | -30Â° | 270Â° |
| 4 | 0Â° | 0Â° |
| 5 | 0Â° | 90Â° |
| 6 | 0Â° | 180Â° |
| 7 | 0Â° | 270Â° |
| 8 | +30Â° | 0Â° |
| 9 | +30Â° | 90Â° |
| 10 | +30Â° | 180Â° |
| 11 | +30Â° | 270Â° |

**æ³¨æ„ç¬¬85è¡Œï¼š**
```python
mp3d_h = np.array([0, 2 * math.pi - h, 0])  # counter-clock heading
```
è¿™é‡Œä½¿ç”¨ `2Ï€ - h` æ„å‘³ç€**å®é™…æ¸²æŸ“çš„headingæ˜¯é€†æ—¶é’ˆè½¬æ¢åçš„**ï¼

### 2. é¢„è®­ç»ƒè§’åº¦ç‰¹å¾ (`common.py`)

```python
# get_view_rel_angles() ç¬¬75-76è¡Œ
else:
    heading += math.radians(90)  # 90Â° é¡ºæ—¶é’ˆå¢é‡
```

**ç”Ÿæˆçš„è§’åº¦ï¼š** æŒ‰ç´¢å¼• `[0Â°, 90Â°, 180Â°, 270Â°, ...]` é¡ºåº

### 3. SFT é˜¶æ®µè§†å›¾å¤„ç† (`R1Policy.py`)

**è¾“å…¥ç›¸æœºé¡ºåºï¼ˆä»Habitatè·å–ï¼‰ï¼š**
- ä¸»ç›¸æœº: 0Â°
- é™„åŠ ç›¸æœº (get_camera_orientations4)ï¼š90Â°, 180Â°, 270Â°

**ç¬¬ä¸€æ¬¡é‡æ’åºï¼ˆra_counté€»è¾‘ï¼‰åï¼š**
```python
ra_count = (NUM_IMGS - a_count) % NUM_IMGS
# å‡è®¾è¾“å…¥é¡ºåº [0Â°, 90Â°, 180Â°, 270Â°]
# è¾“å‡ºé¡ºåº [0Â°, 270Â°, 180Â°, 90Â°] (é¡ºæ—¶é’ˆ)
```

**ç¬¬äºŒæ¬¡é‡æ’åºï¼ˆtorch.flipï¼‰åï¼š**
```python
rgb_feats = torch.cat((rgb[:,0:1,:], torch.flip(rgb[:,1:,:], [1])), dim=1)
# è¾“å…¥ [0Â°, 270Â°, 180Â°, 90Â°]
# è¾“å‡º [0Â°, 90Â°, 180Â°, 270Â°] (é€†æ—¶é’ˆ)
```

### 4. å…³é”®å¯¹æ¯”

| é˜¶æ®µ | è§†å›¾é¡ºåº | è§’åº¦ç‰¹å¾é¡ºåº | æ˜¯å¦ä¸€è‡´ï¼Ÿ |
|------|---------|-------------|-----------|
| **é¢„è®­ç»ƒ** (save_img) | [0Â°, 90Â°, 180Â°, 270Â°] | [0Â°, 90Â°, 180Â°, 270Â°] | âœ… ä¸€è‡´ |
| **SFT** (R1Policy ä¿®å¤å‰) | [0Â°, 90Â°, 180Â°, 270Â°] | [0Â°, 270Â°, 180Â°, 90Â°] | âŒ ä¸ä¸€è‡´ |
| **SFT** (R1Policy ä¿®å¤å) | [0Â°, 90Â°, 180Â°, 270Â°] | [0Â°, 90Â°, 180Â°, 270Â°] | âœ… ä¸€è‡´ |

### 5. ä¸ºä»€ä¹ˆ12ç›®å½±å“å°ï¼Œ4ç›®å½±å“å¤§ï¼Ÿ

**12ç›®ç‰ˆæœ¬çš„è§’åº¦é—´éš”æ˜¯30Â°ï¼š**
- å³ä½¿é¡ºåºåäº†ï¼Œç›¸é‚»è§†å›¾åªå·®30Â°
- æ¨¡å‹çœ‹åˆ°çš„è§†è§‰ç‰¹å¾ä¸è§’åº¦ç‰¹å¾çš„"é”™ä½"ç¨‹åº¦è¾ƒå°
- ä¾‹å¦‚ï¼šç´¢å¼•1çš„è§†å›¾(30Â°)é…äº†ç´¢å¼•1çš„è§’åº¦(330Â°)ï¼Œå·®å€¼æ˜¯60Â° (ä¸¤ä¸ªè§†å›¾è·ç¦»)

**4ç›®ç‰ˆæœ¬çš„è§’åº¦é—´éš”æ˜¯90Â°ï¼š**
- é¡ºåºåäº†ï¼Œç›¸é‚»è§†å›¾å·®90Â°
- æ¨¡å‹çœ‹åˆ°çš„è§†è§‰ç‰¹å¾ä¸è§’åº¦ç‰¹å¾çš„"é”™ä½"ç¨‹åº¦å¾ˆå¤§
- ä¾‹å¦‚ï¼šç´¢å¼•1çš„è§†å›¾(90Â°)é…äº†ç´¢å¼•1çš„è§’åº¦(270Â°)ï¼Œå·®å€¼æ˜¯180Â°ï¼(å®Œå…¨ç›¸åæ–¹å‘)

è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ**4ç›®ç‰ˆæœ¬çš„ä¸ä¸€è‡´å½±å“è¢«æ”¾å¤§äº†3å€**ï¼

12ç›® FOV60Â°ï¼Œé‡å 50% â†’ é”™ä½æ—¶ç›¸é‚»è§†å›¾æœ‰å¤§é‡é‡å ä¿¡æ¯å¯è¡¥å¿
4ç›® FOV=90Â°ï¼Œæ— é‡å  â†’ é”™ä½æ—¶å®Œå…¨çœ‹ä¸åŒåœºæ™¯ï¼Œæ— æ³•è¡¥å¿